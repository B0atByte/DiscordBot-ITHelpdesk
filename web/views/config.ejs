<%- include('header') %>

<h3 class="mb-4"><i class="bi bi-gear"></i> Bot Config (.env)</h3>

<% if (saved) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert">
  บันทึกสำเร็จ! (ต้อง restart bot เพื่อใช้ค่าใหม่)
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %>

<div class="card stat-card p-4">
  <form method="POST" action="/config">
    <div class="mb-3">
      <label class="form-label fw-bold">DISCORD_TOKEN</label>
      <input type="password" name="DISCORD_TOKEN" class="form-control" value="<%= envVars.DISCORD_TOKEN || '' %>" placeholder="Bot Token">
      <div class="form-text">Discord Bot Token</div>
    </div>
    <div class="mb-3">
      <label class="form-label fw-bold">CLIENT_ID</label>
      <input type="text" name="CLIENT_ID" class="form-control" value="<%= envVars.CLIENT_ID || '' %>" placeholder="Application Client ID">
    </div>
    <div class="mb-3">
      <label class="form-label fw-bold">GUILD_ID</label>
      <input type="text" name="GUILD_ID" class="form-control" value="<%= envVars.GUILD_ID || '' %>" placeholder="Discord Server ID">
    </div>
    <div class="mb-3">
      <label class="form-label fw-bold">TICKET_FORUM_CHANNEL_ID</label>
      <input type="text" name="TICKET_FORUM_CHANNEL_ID" class="form-control" value="<%= envVars.TICKET_FORUM_CHANNEL_ID || '' %>" placeholder="Forum Channel ID สำหรับสร้าง Ticket Post">
    </div>
    <div class="mb-3">
      <label class="form-label fw-bold">TICKET_LOG_CHANNEL_ID</label>
      <input type="text" name="TICKET_LOG_CHANNEL_ID" class="form-control" value="<%= envVars.TICKET_LOG_CHANNEL_ID || '' %>" placeholder="Channel ID สำหรับ Log">
    </div>
    <button type="submit" class="btn btn-primary">
      <i class="bi bi-save"></i> บันทึก
    </button>
  </form>
</div>

<div class="card stat-card p-4 mt-4">
  <h5><i class="bi bi-arrow-clockwise"></i> Restart Bot</h5>
  <p class="text-muted mb-3">หลังแก้ไข Config แล้ว กดปุ่มนี้เพื่อ Restart Bot ให้ใช้ค่าใหม่</p>
  <button id="restartBtn" class="btn btn-warning" onclick="restartBot()">
    <i class="bi bi-arrow-clockwise"></i> Restart Bot
  </button>
  <div id="restartAlert" class="mt-3" style="display:none;"></div>
</div>

<script>
async function restartBot() {
  const btn = document.getElementById('restartBtn');
  const alertDiv = document.getElementById('restartAlert');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-hourglass-split"></i> กำลัง Restart...';
  alertDiv.style.display = 'none';
  try {
    const res = await fetch('/config/restart', { method: 'POST' });
    const data = await res.json();
    alertDiv.style.display = 'block';
    if (data.success) {
      alertDiv.className = 'mt-3 alert alert-success';
      alertDiv.textContent = data.message;
    } else {
      alertDiv.className = 'mt-3 alert alert-danger';
      alertDiv.textContent = data.message;
    }
  } catch (e) {
    alertDiv.style.display = 'block';
    alertDiv.className = 'mt-3 alert alert-danger';
    alertDiv.textContent = 'ไม่สามารถ Restart ได้: ' + e.message;
  }
  btn.disabled = false;
  btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Restart Bot';
}
</script>

<%- include('footer') %>
